<html>
<head>
	<style type="text/css">

	#container {
		width: 900px;
		margin: auto;
	}

	#nickWrap {
		position: relative;
		margin: auto;
		text-align: center;
	}

		#chat {
			height: 600px;
			max-height: 600px;
			overflow-y: auto;
			font-family: Helvetica, Arial, 'lucida grande',tahoma,verdana,arial,sans-serif;
			font-size: 12px;
		}

		.date {
			width: 100%;
			clear: both;
			background: honeydew;
			position: relative;
			font-size: 12px;
		}

		.msg {
			font-size: 14px;
			position: relative;
		}

		.msgFrom {
			position: relative;
			top: 16px;
			left: 5px;
		}

		/*chat bubble*/
		.msgBody {
			background: rgba(231, 231, 231, 0.83);
			position: relative;
			left: 60px;
			top: 0px;
			padding: 10px;
			margin: 100px 0 0.5em;
			color: #333;
			background: #eee;
			-webkit-border-radius: 10px;
			-moz-border-radius: 10px;
			border-radius: 10px;
			word-wrap:break-word;
			line-height: 2.25em;
			height: inherit;
			width: 365px;
			margin: 0px;
		}

		/*
		.msgBody:after {
			content: '';
			position: relative;
			border-style: solid;
			border-width: 12px 15px 12px 0;
			border-color: transparent #EFEFEF;
			display: block;
			width: 0;
			z-index: 1;
			left: -25px;
			top: -17px;
		}
		*/

		#contentWrap {
			display: none;
			margin: auto;
			width: 900px;
		}

		#chatWrap {
			border: 1px #000 solid;
			width: 495px;
			height: 600px;
			margin: auto;
			position:relative;
		}

		.error {
			color: red;
		}

		.private {
			color: green;
			font-style: italic;
		}



		#users {
			width: 200px;
			position: absolute;
			right: 500px;
			border: solid 1px black;
			top: -1px;
			height: 100%;
			overflow-y: auto;
		}

		#send-message {
			position: relative;
			left: 210px;
			top: 5px;
			}

		.submission {
			width: 400px;
			height: 50px;
			border: 1px solid black;
			border-radius: 5px;
		}

		#gif_window {
			border: solid 1px black;
			width: 401px;
			height: 600px;
			max-height: 600px;
			position: relative;
			left: 700px;
			bottom: 710px;
			overflow-y: auto;
		}

		#gif_window img {
			width: 190px;
		}

		#gifPull {
			border-radius: 2px;
		}

		#gif_search {
			width: 385px;
			position: relative;
			top: -65px;
			left: 710px;
		}


		input:focus::-webkit-input-placeholder { 
			color:transparent; 
		}

		input:focus:-moz-placeholder { 
			color:transparent; 
		}

		#Gif_Zone {
			display: none;
		}

		#Gif_Button {
			width: 45px;
			height: 160px;
			border: 1px solid black;
			border-radius: 5px;
			position: relative;
			left: 697px;
			bottom: 450px;
			font-family: Helvetica, Arial, 'lucida grande',tahoma,verdana,arial,sans-serif;
			font-size: 12px;
			font-weight: bold;
		}

		#Gif_Hide {
			width: 45px;
			height: 160px;
			border-radius: 5px;
			border: 1px solid black;
			position: relative;
			left: 1102px;
			bottom: 1093px;
			font-family: Helvetica, Arial, 'lucida grande',tahoma,verdana,arial,sans-serif;
			font-size: 20px;
			font-weight: bold;
		}

		.userNameBlock {
			margin: 3px;
			font-family: Helvetica, Arial, 'lucida grande',tahoma,verdana,arial,sans-serif;
			font-size: 12px;
			cursor: pointer;
		}

		/*
		.userNameBlock:hover {
			background: darkseagreen;
		}
		*/

		select:active {
			background: #FFF;
		}


		p { 
			font-family: Verdana;
		}

	</style>

	<title>Mashabout</title>

</head>

<body>

	<div id="container">
		<!--Initial Sign-In Form-->	
	<div id="nickWrap">
		<p>Welcome to Mashabout...</p>
		<img src="http://www.reactiongifs.com/r/trip1.gif">
		<p>Choose Your Name</p>
		<p id="nickError"></p>
		<form id="setNick">
			<input size="35" id="nickname"></input>
			<input type="submit"></input>
		</form>	
	</div>
		<!--Chat Page Seen Upon Sign-In-->	
		<div id="contentWrap">

			<div id="chatWrap">
				<select id="users" size="25">
				</select>
				<div id="chat">
				</div>	
			</div>

				<form id="send-message" >
						<input size="65" id="message" class="submission" placeholder="Type something, drag a gif or add a link here yo"></input>
						<input type="submit"></input>
				</form>

					<div id="Gif_Zone">
						<form id="gif_search">
							<select id="select_channel">
								<option value="giphy">Giphy</a>
								<option value="replygif">ReplyGif</a>
							</select>		
							<input id="gifPull" size="32"  placeholder="Search for a GIF i.e. 'lol'"></input>
							<input type="submit"></input>		
						</form>

						<div id="gif_window">	
						</div>

						<button id="Gif_Hide">X</button>		
					</div>

					<button id="Gif_Button">Gifs</button>


		</div>
		</div>



	

	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		/*var unixtime = Date.now();
			var newDate = new Date();
			newDate.setTime(unixtime * 1000);
			dateString = newDate.toUTCString();
			*/

		jQuery(function($){
			var socket = io.connect();
			var $nickForm = $('#setNick');
			var $nickError = $('#nickError');
			var $nickBox = $('#nickname');
			var $users = $('#users');
			var $messageForm = $('#send-message');
			var $messageBox = $('#message');
			var $chat = $('#chat');
			var $gifWindow = $('#gif_window');
			var $gifButton = $('#Gif_Button');
			var $gifHide = $('#Gif_Hide');
			var $clickUser = $('#clickUser');
			var $selectChannel = $('#select_channel');

			

			
			

			
			//homepage 'login' - submit name, emit to server
			$nickForm.submit(function(e) {
				e.preventDefault();
				socket.emit('new user', $nickBox.val(), function(data) {
					if(data) {
						$('#nickWrap').hide();
						$('#contentWrap').show();
					} else {
						$nickError.html('That name is taken bro, try another one.')
					}
				});
				$nickBox.val('');
			});

			socket.on('usernames', function(data) {
				var html = '';
				html += '<option id="group">Group</option>';
				for(var i = 0; i < data.length; i++) {
					html += '<option class=\"userNameBlock\" id=\"clickUser\">' + data[i] + '</option>';
				}
				$users.html(html);
			});

			//private message grab
			var pmTarget;
			$("#users").on("click", 'option', function(event) {
  					//alert($(this).text());
  					//private message grab
  					pmTarget = $(this).text();
  					//add class to clicked element
					});

			$('#group').on("click", 'option', function(event) {
				pmTarget = ' ';
			});


			$messageForm.submit(function(e){
				e.preventDefault();
				socket.emit('send message', $messageBox.val(), pmTarget, function() {
					$chat.append('<span class="error">' + data + "</span><br/>");
				});
				$messageBox.val('');
			});	


			socket.on('load old msgs', function(docs) {
				for(var i=docs.length-1; i >= 0; i--) {
					displayMsg(docs[i]);
				}
			});
			
			socket.on('new message', function(data){
				displayMsg(data);
			});

			socket.on('error', function(data) {
				displayMsg(data);
			});

			function displayMsg(data) {
				/*
				 var scrollPosition = $("#chat").scrollTop();
				 var scrollHeight = $("#chat")[0].scrollHeight();
				 */
					$chat.append(/*'<br><span class="date">' + Date.now() + '</span><br/>'+ */ '<div class="msg"><div class="msgFrom"><b>' + data.nick + ': </b></div>' + '<div class ="msgBody">' + data.msg + '</div>' + "</div><br/>");
					$chat.scrollTop($chat[0].scrollHeight);
					/*
				    if (scrollPosition + $chat.height() === scrollHeight) { 
				        $chat.scrollTop(scrollHeight);       
    				}
    				*/
			}


			//private messaging is working to a degree. Now a visual indicator is needed.
			socket.on('private', function(data) {
				$chat.append('<span class="private msg"><b>' + data.nick + ': </b><div class ="msgBody">' + data.msg + "</div></span><br/>");
				$chat.scrollTop($chat[0].scrollHeight);
			});

			$gifButton.on('click',function() {
				$('#Gif_Zone').show(5);
				$gifButton.hide(5);
			});

			$gifHide.on('click',function() {
				$('#Gif_Zone').hide(5);
				$gifButton.show(5);
			});

			
			//Gif Search 
			var $gifsearch = $('#gif_search');


				$gifsearch.submit(function(e){
						e.preventDefault();
						if($selectChannel.val() == 'giphy') {
							//Giphy.com
								//we are now pulling the search query into the URL and grabbing a JSON object
						var getGif = "http://api.giphy.com/v1/gifs/search?q=" + $('#gifPull').val() + "&api_key=dc6zaTOxFJmzC&limit=50";
						//data object returned, now we need to pull the img url from the object and append them with img tags
						 
								$.getJSON(getGif, function(gifs) {
									for (var i = 0; i < gifs.data.length; i++) {
								  		$gifWindow.append('<img src=\"' + gifs.data[i].images.fixed_height.url + '\"\/>'); 
								  	}
								  });
						} else {
							//ReplyGif.net
							var getGif = "http://replygif.net/api/gifs?tag=" + $('#gifPull').val() + "&tag-operator=and&api-key=39YAprx5Yi";

						$.getJSON(getGif,function(json) {
							if (json.length == 0) {
								$gifWindow.append("<p>ReplyGif doesn't have the tag <b>\'" + $('#gifPull').val() + "\'</b> :( try something else?</p>");
							}
						});

								$.getJSON(getGif, function(gifs) {
							      for(var i = 0; i < gifs.length; i++) {
							          $gifWindow.append('<img src=\"' + gifs[i].file + '\"\/>');
				              		}
				     			});
						}
						
								 
					});
					
		//end script
		});

		
	</script>


		

</body>
</html>